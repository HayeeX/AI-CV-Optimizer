<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI CV Optimizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Libraries for PDF, DOCX parsing and DOCX generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/docx@8.2.2/build/index.umd.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        textarea {
            resize: vertical;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-900">AI CV Optimizer</h1>
            <p class="text-slate-600 mt-2">Tailor your CV to any job description instantly and beat the bots.</p>
        </header>

        <main class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
            <!-- Input Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-6">
                <div>
                    <label class="block text-lg font-semibold mb-2 text-slate-700">Your Current CV</label>
                    <div id="drop-zone" class="mt-2 flex justify-center rounded-lg border border-dashed border-slate-900/25 px-6 py-10 transition duration-200">
                        <div class="text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-300" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                 <path d="M9 8.25H7.5a2.25 2.25 0 0 0-2.25 2.25v9a2.25 2.25 0 0 0 2.25 2.25h9A2.25 2.25 0 0 0 18.75 19.5v-9a2.25 2.25 0 0 0-2.25-2.25H15M9 8.25V6a2.25 2.25 0 0 1 2.25-2.25h1.5A2.25 2.25 0 0 1 15 6v2.25M9 8.25h6M12 16.5h3.375m-3.375-3h3.375m-3.375 6h3.375M9 13.5H7.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                            </svg>
                            <div class="mt-4 flex text-sm leading-6 text-gray-600">
                                <label for="cv-upload" class="relative cursor-pointer rounded-md bg-white font-semibold text-blue-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-blue-600 focus-within:ring-offset-2 hover:text-blue-500">
                                    <span>Upload a file</span>
                                    <input id="cv-upload" name="cv-upload" type="file" class="sr-only" accept=".txt,.pdf,.docx">
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs leading-5 text-gray-600">PDF, DOCX, or TXT files</p>
                            <p id="file-name-display" class="text-sm font-medium text-slate-700 mt-2"></p>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="jd-input" class="block text-lg font-semibold mb-2 text-slate-700">Job Description</label>
                    <textarea id="jd-input" rows="15" class="w-full p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200" placeholder="Paste the job description you are applying for..."></textarea>
                </div>
            </div>

            <!-- Action Button -->
            <div class="text-center">
                <button id="optimize-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105 shadow-md flex items-center justify-center mx-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
                    Optimize My CV
                </button>
            </div>
            
            <div id="loader" class="hidden flex justify-center items-center my-6">
                <div class="loader"></div>
                <p class="ml-4 text-slate-600">Optimizing... this may take a moment.</p>
            </div>

            <!-- Output Section -->
            <div id="output-container" class="mt-10 hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-slate-900">Your Optimized CV</h2>
                     <div class="flex items-center">
                        <button id="copy-btn" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition duration-300 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                            Copy
                        </button>
                        <button id="download-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300 flex items-center ml-2 hidden">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                            Download (.docx)
                        </button>
                    </div>
                </div>
                <div id="optimized-cv" class="w-full p-6 border border-slate-300 rounded-lg bg-slate-50 min-h-[400px] whitespace-pre-wrap"></div>
                 <div id="error-message" class="hidden text-red-600 bg-red-100 p-4 rounded-lg"></div>
            </div>
        </main>
        
        <footer class="text-center mt-8 text-slate-500 text-sm">
            <p>Powered by AI. Always review the generated CV before applying.</p>
        </footer>
    </div>

    <script>
        const optimizeBtn = document.getElementById('optimize-btn');
        const cvUploadInput = document.getElementById('cv-upload');
        const jdInput = document.getElementById('jd-input');
        const loader = document.getElementById('loader');
        const outputContainer = document.getElementById('output-container');
        const optimizedCvOutput = document.getElementById('optimized-cv');
        const errorMessage = document.getElementById('error-message');
        const copyBtn = document.getElementById('copy-btn');
        const downloadBtn = document.getElementById('download-btn');
        const fileNameDisplay = document.getElementById('file-name-display');
        const dropZone = document.getElementById('drop-zone');
        
        let optimizedCvData = null;

        // File upload UI logic
        cvUploadInput.addEventListener('change', () => {
            if (cvUploadInput.files.length > 0) {
                fileNameDisplay.textContent = cvUploadInput.files[0].name;
            } else {
                fileNameDisplay.textContent = '';
            }
        });

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('border-blue-500', 'bg-slate-50'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('border-blue-500', 'bg-slate-50'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); e.stopPropagation();
            dropZone.classList.remove('border-blue-500', 'bg-slate-50');
            if (e.dataTransfer.files.length > 0) {
                cvUploadInput.files = e.dataTransfer.files;
                cvUploadInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });

        // Main optimization logic
        optimizeBtn.addEventListener('click', async () => {
            const cvFile = cvUploadInput.files[0];
            const jdText = jdInput.value.trim();

            if (!cvFile || !jdText) { alert('Please upload a CV file and fill in the Job Description field.'); return; }

            // UI updates for loading state
            optimizeBtn.disabled = true;
            optimizeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            loader.classList.remove('hidden');
            outputContainer.classList.add('hidden');
            errorMessage.classList.add('hidden');
            downloadBtn.classList.add('hidden');
            optimizedCvData = null;

            try {
                const cvText = await extractTextFromFile(cvFile);
                if (!cvText) throw new Error("Could not extract text from the uploaded file. It might be empty or in an unsupported format.");
                
                const resultJson = await callGeminiAPI(cvText, jdText);
                optimizedCvData = JSON.parse(resultJson); // Store the parsed JSON
                
                const formattedText = formatCvJsonToText(optimizedCvData); // Format for display
                optimizedCvOutput.textContent = formattedText;
                
                outputContainer.classList.remove('hidden');
                downloadBtn.classList.remove('hidden'); // Show download button
            } catch (error) {
                console.error('Error:', error);
                errorMessage.textContent = 'Sorry, something went wrong. The AI may have returned an invalid format. ' + error.message;
                errorMessage.classList.remove('hidden');
                outputContainer.classList.remove('hidden'); 
                optimizedCvOutput.textContent = '';
            } finally {
                loader.classList.add('hidden');
                optimizeBtn.disabled = false;
                optimizeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
        
        // File parsing logic
        function extractTextFromFile(file) {
            const fileName = file.name.toLowerCase();
            if (fileName.endsWith('.txt')) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => reject(reader.error);
                    reader.readAsText(file);
                });
            } else if (fileName.endsWith('.pdf')) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            window['pdfjs-dist/build/pdf'].GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
                            const pdf = await window['pdfjs-dist/build/pdf'].getDocument({ data: event.target.result }).promise;
                            let fullText = '';
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                fullText += textContent.items.map(item => item.str).join(' ') + '\n\n';
                            }
                            resolve(fullText);
                        } catch (error) { reject(error); }
                    };
                    reader.readAsArrayBuffer(file);
                });
            } else if (fileName.endsWith('.docx')) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const result = await mammoth.extractRawText({ arrayBuffer: event.target.result });
                            resolve(result.value);
                        } catch (error) { reject(error); }
                    };
                    reader.readAsArrayBuffer(file);
                });
            } else {
                return Promise.reject(new Error('Unsupported file type. Please upload a .txt, .pdf, or .docx file.'));
            }
        }
        
        // New function to format JSON to plain text for the text area
        function formatCvJsonToText(data) {
            let text = `${data.name}\n${data.contact.email} | ${data.contact.phone} | ${data.contact.linkedin}\n\n`;
            text += `--- SUMMARY ---\n${data.summary}\n\n`;
            text += `--- EXPERIENCE ---\n`;
            data.experience.forEach(exp => {
                text += `${exp.title} at ${exp.company} (${exp.dates})\n`;
                exp.duties.forEach(duty => text += `  - ${duty}\n`);
                text += '\n';
            });
            text += `--- EDUCATION ---\n`;
            data.education.forEach(edu => {
                text += `${edu.degree}, ${edu.school} (${edu.dates})\n`;
            });
            text += `\n--- SKILLS ---\n${data.skills.join(', ')}`;
            return text;
        }

        // Action buttons
        copyBtn.addEventListener('click', () => {
            const textToCopy = optimizedCvOutput.textContent;
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                copyBtn.textContent = 'Copied!';
                setTimeout(() => { copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg> Copy`; }, 2000);
            } catch (err) { console.error('Failed to copy text: ', err); }
            document.body.removeChild(textArea);
        });
        
        downloadBtn.addEventListener('click', () => {
            if (optimizedCvData) {
                generateDocx(optimizedCvData);
            }
        });

        // DOCX Generation
        function generateDocx(data) {
            const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;

            const formatSection = (title, children) => {
                return [
                    new Paragraph({
                        heading: HeadingLevel.HEADING_2,
                        children: [new TextRun({ text: title, bold: true, size: 28 })],
                        spacing: { before: 400, after: 200 }
                    }),
                    ...children
                ];
            };
            
            const doc = new Document({
                sections: [{
                    children: [
                        new Paragraph({ heading: HeadingLevel.HEADING_1, children: [new TextRun({ text: data.name, bold: true, size: 40 })] }),
                        new Paragraph({ children: [new TextRun({ text: `${data.contact.email} | ${data.contact.phone} | ${data.contact.linkedin}`, size: 22 })] }),
                        ...formatSection("Professional Summary", [new Paragraph({ children: [new TextRun(data.summary)] })]),
                        ...formatSection("Work Experience", data.experience.flatMap(exp => [
                            new Paragraph({ children: [new TextRun({ text: exp.title, bold: true, size: 24 })] }),
                            new Paragraph({ children: [new TextRun({ text: `${exp.company} | ${exp.dates}`, size: 22 })] }),
                            ...exp.duties.map(duty => new Paragraph({ text: duty, bullet: { level: 0 }, indent: { left: 720 } })),
                            new Paragraph(" ") // Spacer
                        ])),
                        ...formatSection("Education", data.education.map(edu => 
                           new Paragraph({ children: [new TextRun({ text: `${edu.degree}, ${edu.school} (${edu.dates})`, size: 22 })] })
                        )),
                        ...formatSection("Skills", [new Paragraph({ children: [new TextRun(data.skills.join(', '))] })]),
                    ],
                }],
            });

            Packer.toBlob(doc).then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `${data.name.replace(' ', '_')}_CV.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }

        async function callGeminiAPI(cv, jobDescription) {
            const apiKey = ""; // API key will be injected by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = `You are an expert career coach. Your task is to analyze the provided CV and job description and rewrite the CV to be optimized for the role and ATS systems.
            You MUST return the output as a single, valid JSON object. Do not include any text before or after the JSON object.
            The JSON object must follow this exact structure:
            {
              "name": "Full Name",
              "contact": {
                "email": "email@address.com",
                "phone": "Your Phone Number",
                "linkedin": "linkedin.com/in/yourprofile"
              },
              "summary": "A 2-3 sentence professional summary tailored to the job description.",
              "experience": [
                {
                  "title": "Job Title",
                  "company": "Company Name",
                  "dates": "Month Year - Month Year",
                  "duties": ["A bullet point describing a key achievement, starting with an action verb.", "Another achievement...", "Quantify results where possible."]
                }
              ],
              "education": [
                {
                  "degree": "Degree and Major",
                  "school": "University Name",
                  "dates": "Month Year - Month Year"
                }
              ],
              "skills": ["Relevant Skill 1", "Skill 2", "ATS Keyword 3"]
            }
            Summarize the content to fit comfortably on two standard pages. Focus on action verbs and quantifiable results.`;

            const userQuery = `My Current CV:\n---\n${cv}\n---\n\nJob Description:\n---\n${jobDescription}\n---`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                 generationConfig: { responseMimeType: "application/json" }
            };
            
            let response;
            let retries = 3;
            let delay = 1000;

            while (retries > 0) {
                try {
                    response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            return candidate.content.parts[0].text; // Returns the JSON string
                        } else {
                            const finishReason = candidate?.finishReason;
                            const safetyRatings = JSON.stringify(candidate?.safetyRatings, null, 2);
                            throw new Error(`The model returned an empty or invalid response. Finish Reason: ${finishReason}. Safety Ratings: ${safetyRatings}`);
                        }
                    } else if (response.status === 429) {
                        console.warn(`API throttling. Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; retries--;
                    } else { throw new Error(`API request failed with status: ${response.status}`); }
                } catch (error) {
                    console.error('Fetch attempt failed:', error.message);
                    if (retries === 1) throw error; 
                    retries--;
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
            throw new Error('Failed to get a response from the AI after multiple retries.');
        }

    </script>
</body>
</html>

